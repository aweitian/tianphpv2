<?xml version="1.0" encoding="UTF-8"?>
<sql>
	<data_channel>
		<getRow>
			SELECT 
				`ch_id`,`ch_val`
			 FROM `data_channel` WHERE `ch_val` = :ch_val
		</getRow>	
		<getRows>
			SELECT 
				`ch_id`,`ch_val`
			 FROM `data_channel` WHERE 1
		</getRows>	
		<insert>
			INSERT INTO `data_channel` (
				`ch_val`
			) VALUES (
				:ch_val
			)
		</insert>
	</data_channel>

	<data_account>
		<getRow>
			SELECT 
			`ac_id`,`ch_id`,`ac_val`
		 FROM `data_account` 
		 WHERE `ch_id` = :ch_id AND `ac_val` = :ac_val
		</getRow>	
		<getRowsByChId>
			SELECT 
				`ac_id`,`ch_id`,`ac_val`
			 FROM `data_account` 
			 WHERE `ch_id` = :ch_id
		</getRowsByChId>
		<insert>
			INSERT INTO `data_account` (
				`ch_id`,`ac_val`
			) VALUES (
				:ch_id,:ac_val
			)
		</insert>
	
	</data_account>
	
	<data_plan>
		<getRow>
			SELECT 
			`pl_id`,`ac_id`,`pl_val`
		 FROM `data_plan` 
				WHERE `ac_id` = :ac_id AND `pl_val` = :pl_val
		</getRow>	
		<getRowsByAccId>
			SELECT 
			`pl_id`,`ac_id`,`pl_val`
		 FROM `data_plan` 
				WHERE `ac_id` = :ac_id
		</getRowsByAccId>
		<insert>
			INSERT INTO `data_plan` (
				`ac_id`,`pl_val`
			) VALUES (
				:ac_id,:pl_val
			)
		</insert>
	
	</data_plan>

	<data_unit>
		<getRow>
			SELECT 
			`un_id`,`pl_id`,`un_val`
		 FROM `data_unit` WHERE `pl_id` = :pl_id AND `un_val` = :un_val
		</getRow>
		<getRowsByPlanId>
			SELECT 
			`un_id`,`pl_id`,`un_val`
		 FROM `data_unit` WHERE `pl_id` = :pl_id
		</getRowsByPlanId>	
		<insert>
			INSERT INTO `data_unit` (
				`pl_id`,`un_val`
			) VALUES (
				:pl_id,:un_val
			)
		</insert>
		<update>
			UPDATE `data_unit` SET 
				`un_code_pc`=:un_code_pc,`un_code_m`=:un_code_m
			 WHERE `un_id`=:un_id
		</update>
	</data_unit>
	
	
	<data_idea>
		<getRow>
			SELECT 
			`id_id`,`un_id`,`title`,`desc1`,`desc2`,`url`
 		FROM `data_idea` 
		WHERE `un_id` = :un_id 
		  AND `title` = :title
		  AND `desc1` = :desc1
		  AND `desc2` = :desc2
		</getRow>	
		<insert>
			INSERT INTO `data_idea` (
				`un_id`,`title`,`desc1`,`desc2`,`url`
			) VALUES (
				:un_id,:title,:desc1,:desc2,:url
			)
		</insert>
		<update>
			UPDATE `data_idea` SET 
				`id_code_pc`=:id_code_pc,`id_code_m`=:id_code_m
			WHERE `id_id`=:id_id
		</update>
	</data_idea>
	
	
	<log_upload_token>
		<getRowByToken>
			SELECT * FROM `log_upload_token` WHERE `token` = :token
		</getRowByToken>
		
		<insert>
			INSERT INTO `log_upload_token` (
				`token`,`cls`,`name`,`cnt`
			) VALUES (
				:token,:cls,:name,:cnt
			)
		</insert>
	
	</log_upload_token>
	
	
	<log_load_token>
		<getRowByToken>
			select * from `log_load_token` where
					`token` = :token order by sid desc limit 0,1
		</getRowByToken>
		
		<insert>
			INSERT INTO `log_load_token` (
				`token`
			) VALUES (
				:token
			)
		</insert>
	
	</log_load_token>
	
	<publ_data>
	
		<insert>
			INSERT INTO `publ_data` (
				`id_id`,`paysum`,`shows`,`clks`,`dev`,`date`,`hour`
			) VALUES (
				:id_id,:paysum,:shows,:clks,:dev,:date,:hour
			)
			ON DUPLICATE KEY UPDATE 
				`paysum` = `paysum` + :paysum,
				`shows` = `shows` + :shows,
				`clks` = `clks` + :clks
		</insert>
	
	
	</publ_data>
	
	
	<priv_data>
		<insert>
		
			INSERT INTO `prvt_data` (
				`code`,`chat`,`subscribe`,`rcvpayment`,`link`,`kw`,`mark`,`date`,`hour`
			) VALUES (
				:code,:chat,:subscribe,:rcvpayment,:link,:kw,:mark,:date,:hour
			)
			ON DUPLICATE KEY UPDATE 
				`chat` = `chat` + :chat,
				`subscribe` = `subscribe` + :subscribe,
				`rcvpayment` = `rcvpayment` + :rcvpayment
		
		</insert>
	
	
	</priv_data>
	
	
	<query>
		<mem_data_tree>
			(
				SELECT 
				`data_channel`.`ch_id`,
				`data_channel`.`ch_val`,
				`data_account`.`ac_id`,
				`data_account`.`ac_val`,
				`data_plan`.`pl_id`,
				`data_plan`.`pl_val`,
				`data_unit`.`un_id`,
				`data_unit`.`un_val`,
				`data_unit`.`un_code_pc`,
				`data_unit`.`un_code_m`,
				GROUP_CONCAT(`data_idea`.`id_code_pc`) AS `grp_id_code_pc`,
				GROUP_CONCAT(`data_idea`.`id_code_m`) AS `grp_id_code_m`,
				GROUP_CONCAT(`data_idea`.`id_id`) AS `grp_id_id`
				FROM `data_account`
				RIGHT JOIN `data_channel`
				ON `data_channel`.`ch_id` = `data_account`.`ch_id`
				RIGHT JOIN `data_plan`
				ON `data_plan`.`ac_id` = `data_account`.`ac_id`
				RIGHT JOIN `data_unit`
				ON `data_unit`.`pl_id` = `data_plan`.`pl_id`
				LEFT JOIN `data_idea`
				ON `data_idea`.`un_id` = `data_unit`.`un_id`
				GROUP BY `data_unit`.`un_id`
			) AS `mem_data_tree`
		</mem_data_tree>
		<level_channel>
			
			<grp>
			SELECT 
				`mem_data_tree`.`ch_val`,
				SUM(`publ_data`.`paysum`),SUM(`publ_data`.`shows`),SUM(`publ_data`.`clks`),
				SUM(`prvt_data`.`chat`),SUM(`prvt_data`.`subscribe`),SUM(`prvt_data`.`rcvpayment`)
			FROM @mem_data_tree
			
			RIGHT JOIN `prvt_data` ON (
				`prvt_data`.`code` = `mem_data_tree`.`un_code_pc`
				OR
				`prvt_data`.`code` = `mem_data_tree`.`un_code_m`
				OR
				FIND_IN_SET(`prvt_data`.`code` , `mem_data_tree`.`grp_id_code_pc`)
				OR
				FIND_IN_SET(`prvt_data`.`code` , `mem_data_tree`.`grp_id_code_m`)
			)
			RIGHT JOIN `publ_data` ON FIND_IN_SET(`publ_data`.`id_id` , `mem_data_tree`.`grp_id_id`)
			
			GROUP BY `mem_data_tree`.`ch_id`

			</grp>
			<div>
			
			</div>
		</level_channel>
	
	
	</query>
	
	
	<build_mem_tree>
	
		DROP TABLE mem_data_tree;
		CREATE TABLE mem_data_tree ENGINE=MEMORY CHARSET=utf8
			SELECT 
			`data_channel`.`ch_id`,
			`data_channel`.`ch_val`,
			`data_account`.`ac_id`,
			`data_account`.`ac_val`,
			`data_plan`.`pl_id`,
			`data_plan`.`pl_val`,
			`data_unit`.`un_id`,
			`data_unit`.`un_val`
			FROM `data_account`
			RIGHT JOIN `data_channel`
			ON `data_channel`.`ch_id` = `data_account`.`ch_id`
			RIGHT JOIN `data_plan`
			ON `data_plan`.`ac_id` = `data_account`.`ac_id`
			RIGHT JOIN `data_unit`
			ON `data_unit`.`pl_id` = `data_plan`.`pl_id`
	
	</build_mem_tree>
	
	
	
</sql>